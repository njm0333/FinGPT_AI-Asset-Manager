# =========================
# íˆ¬ì ì„±í–¥ ì„¤ëª… / ìì—°ì–´ ë¦¬í¬íŠ¸ ìœ í‹¸
# =========================

RISK_PROFILES = {
    "ì•ˆì •í˜•": "ì˜ˆê¸ˆì´ë‚˜ ì ê¸ˆ ìˆ˜ì¤€ì˜ ìˆ˜ìµë¥ ì„ ê¸°ëŒ€í•˜ë©°, íˆ¬ìì›ê¸ˆì— ì†ì‹¤ì´ ë°œìƒí•˜ëŠ” ê²ƒì„ ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. "
           "ì›ê¸ˆ ì†ì‹¤ì˜ ìš°ë ¤ê°€ ì—†ëŠ” ìƒí’ˆì— íˆ¬ìí•˜ëŠ” ë° ë°”ëŒì§í•œ ì„±í–¥ì…ë‹ˆë‹¤.",
    "ì•ˆì •ì¶”êµ¬í˜•": "íˆ¬ìì›ê¸ˆì˜ ì†ì‹¤ ìœ„í—˜ì€ ìµœì†Œí™”í•˜ê³ , ì´ìÂ·ë°°ë‹¹ ë“± ì•ˆì •ì ì¸ ìˆ˜ìµì„ ëª©í‘œë¡œ í•©ë‹ˆë‹¤. "
             "ë‹¤ë§Œ ìˆ˜ìµì„ ìœ„í•´ ë‹¨ê¸°ì ì¸ ì†ì‹¤ì„ ìˆ˜ìš©í•  ìˆ˜ ìˆìœ¼ë©° ì¼ë¶€ë¥¼ ë³€ë™ì„± ë†’ì€ ìƒí’ˆì—ë„ íˆ¬ìí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
    "ìœ„í—˜ì¤‘ë¦½í˜•": "íˆ¬ìì—ëŠ” ìœ„í—˜ì´ ìˆë‹¤ëŠ” ê²ƒì„ ì¸ì‹í•˜ê³  ìˆìœ¼ë©°, ì˜ˆÂ·ì ê¸ˆë³´ë‹¤ ë†’ì€ ìˆ˜ìµì„ ê¸°ëŒ€í•œë‹¤ë©´ ì¼ì • ìˆ˜ì¤€ì˜ ì†ì‹¤ ìœ„í—˜ì„ ê°ìˆ˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
    "ì ê·¹íˆ¬ìí˜•": "ì›ê¸ˆ ë³´ì „ë³´ë‹¤ ë†’ì€ ìˆ˜ì¤€ì˜ ìˆ˜ìµì„ ì¶”êµ¬í•˜ëŠ” í¸ì´ë©°, íˆ¬ììê¸ˆì˜ ìƒë‹¹ ë¶€ë¶„ì„ ì£¼ì‹, ì£¼ì‹í˜• í€ë“œ, íŒŒìƒìƒí’ˆ ë“± ìœ„í—˜ìì‚°ì— íˆ¬ìí•  ì˜í–¥ì´ ìˆìŠµë‹ˆë‹¤.",
    "ê³µê²©íˆ¬ìí˜•": "ì‹œì¥í‰ê· ìˆ˜ìµë¥ ë³´ë‹¤ í¬ê²Œ ë†’ì€ ìˆ˜ìµì„ ëª©í‘œë¡œ í•˜ë©°, í° ì†ì‹¤ ìœ„í—˜ë„ ì ê·¹ ìˆ˜ìš©í•©ë‹ˆë‹¤. "
             "íˆ¬ììê¸ˆ ëŒ€ë¶€ë¶„ì„ ê³ ìœ„í—˜ ìì‚°ì— íˆ¬ìí•˜ëŠ” ì„±í–¥ì…ë‹ˆë‹¤."
}

_RISK_LEVEL = {
    "ì•ˆì •í˜•": 1,
    "ì•ˆì •ì¶”êµ¬í˜•": 2,
    "ìœ„í—˜ì¤‘ë¦½í˜•": 3,
    "ì ê·¹íˆ¬ìí˜•": 4,
    "ê³µê²©íˆ¬ìí˜•": 5,
}


def _factor_role_comment(factor_idx: int, factor_name: str, n_factors: int) -> str:
    """
    Factor 1, 2, 3... ì— ëŒ€í•´ ì´ˆë³´ììš© ê°„ë‹¨ ì—­í•  ì„¤ëª….
    PCA íŠ¹ì„±ìƒ 'ì •ë‹µ'ì€ ì•„ë‹ˆì§€ë§Œ, ë³´í†µ ì´ë ‡ê²Œ í•´ì„ë˜ëŠ” ê²½ìš°ê°€ ë§ë‹¤ ìˆ˜ì¤€ìœ¼ë¡œ ì •ë¦¬.
    """
    base = f"{factor_name}ëŠ” PCAë¡œ ì¶”ì¶œëœ ìš”ì¸ ì¤‘ {factor_idx}ë²ˆì§¸ë¡œ ì¤‘ìš”í•œ ìš”ì¸ì…ë‹ˆë‹¤. "

    if factor_idx == 1:
        base += "ëŒ€ë¶€ë¶„ì˜ ì¢…ëª©ì´ í•¨ê»˜ ì˜¤ë¥´ë‚´ë¦¬ëŠ”, ì‹œì¥ ì „ì²´ ë°©í–¥ê³¼ ë¹„ìŠ·í•œ ì›€ì§ì„ì„ ë‹´ëŠ” ê²½ìš°ê°€ ë§ìŠµë‹ˆë‹¤."
    elif factor_idx == 2:
        base += "ì„±ì¥ì£¼ vs ê°€ì¹˜ì£¼, í˜¹ì€ ê³µê²©ì  ìŠ¤íƒ€ì¼ vs ë°©ì–´ì  ìŠ¤íƒ€ì¼ì²˜ëŸ¼ ìŠ¤íƒ€ì¼ ì°¨ì´ë¥¼ ë°˜ì˜í•˜ëŠ” ê²½ìš°ê°€ ìì£¼ ìˆìŠµë‹ˆë‹¤."
    elif factor_idx == 3:
        base += "ê¸ˆìœµÂ·í•„ìˆ˜ì†Œë¹„ì¬Â·í—¬ìŠ¤ì¼€ì–´ ê°™ì€ ë°©ì–´ì£¼, í˜¹ì€ íŠ¹ì • ì—…ì¢…êµ°ì— ì¡°ê¸ˆ ë” ë¯¼ê°í•œ ìš”ì¸ìœ¼ë¡œ í•´ì„ë˜ëŠ” ê²½ìš°ê°€ ë§ìŠµë‹ˆë‹¤."
    else:
        base += "íŠ¹ì • ì„¹í„°ë‚˜ í…Œë§ˆ(ì˜ˆ: ë°˜ë„ì²´, ì „ê¸°ì°¨ ë“±)ì— ë” íŠ¹í™”ëœ ì›€ì§ì„ì„ ë‹´ëŠ” ê²½ìš°ê°€ ë§ìŠµë‹ˆë‹¤."

    return base


def _factor_short_name(factor_idx: int) -> str:
    """
    ë¸Œë¦¿ì§€ ë¬¸ì¥ì— ì“°ê¸° ìœ„í•œ ì•„ì£¼ ì§§ì€ ì„¤ëª… íƒœê·¸.
    """
    if factor_idx == 1:
        return "ì‹œì¥ ì „ì²´ ë°©í–¥ ìš”ì¸"
    elif factor_idx == 2:
        return "ì„±ì¥/ìŠ¤íƒ€ì¼ ìš”ì¸"
    elif factor_idx == 3:
        return "ì„¹í„°/ë°©ì–´í˜• ì„±ê²©ì˜ ìš”ì¸"
    else:
        return "íŠ¹ì • í…Œë§ˆÂ·ì—…ì¢… ì„±ê²©ì˜ ìš”ì¸"


def _diff_comment(actual: float, target: float) -> str:
    """
    ì‹¤ì œ ë…¸ì¶œê³¼ ëª©í‘œ ë…¸ì¶œì˜ ì°¨ì´ë¥¼ ì‰¬ìš´ ë§ë¡œ ìš”ì•½.
    """
    diff = actual - target
    gap = abs(diff)

    if gap < 0.03:
        return "ëª©í‘œì™€ ê±°ì˜ ë¹„ìŠ·í•œ ìˆ˜ì¤€ì…ë‹ˆë‹¤."
    elif gap < 0.08:
        if diff > 0:
            return "ëª©í‘œë³´ë‹¤ ì•½ê°„ ë” ë§ì´ ë‹´ê³  ìˆìŠµë‹ˆë‹¤."
        else:
            return "ëª©í‘œë³´ë‹¤ ì•½ê°„ ëœ ë‹´ê³  ìˆìŠµë‹ˆë‹¤."
    elif gap < 0.15:
        if diff > 0:
            return "ëª©í‘œë³´ë‹¤ ë‹¤ì†Œ ë§ì´ ë“¤ì–´ê°€ ìˆëŠ” í¸ì…ë‹ˆë‹¤."
        else:
            return "ëª©í‘œë³´ë‹¤ ë‹¤ì†Œ ë¶€ì¡±í•œ í¸ì…ë‹ˆë‹¤."
    else:
        if diff > 0:
            return "ëª©í‘œë³´ë‹¤ ìƒë‹¹íˆ ë§ì´ ë“¤ì–´ê°€ ìˆì–´ ì ë¦¼ì´ í¬ê²Œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤."
        else:
            return "ëª©í‘œë³´ë‹¤ ìƒë‹¹íˆ ë¶€ì¡±í•œ í¸ì´ë¼ ì„±í–¥ ëŒ€ë¹„ ë…¸ì¶œì´ ì•½í•œ í¸ì…ë‹ˆë‹¤."


def _momentum_comment(v: float) -> str:
    """
    ìµœê·¼ 6ê°œì›” ëˆ„ì  ìˆ˜ìµë¥ ì— ëŒ€í•œ í•œ ì¤„ í•´ì„.
    """
    if np.isnan(v):
        return "ë°ì´í„°ê°€ ë¶€ì¡±í•´ ìµœê·¼ ì„±ê³¼ë¥¼ í‰ê°€í•˜ê¸° ì–´ë µìŠµë‹ˆë‹¤."
    if v > 0.50:
        return "ìµœê·¼ 6ê°œì›” ë™ì•ˆ ë§¤ìš° ê°•í•œ ìƒìŠ¹ íë¦„ì„ ë³´ì˜€ìŠµë‹ˆë‹¤."
    elif v > 0.20:
        return "ìµœê·¼ 6ê°œì›” ë™ì•ˆ ë¹„êµì  ì¢‹ì€ ìƒìŠ¹ íë¦„ì„ ë³´ì˜€ìŠµë‹ˆë‹¤."
    elif v > 0.05:
        return "ìµœê·¼ 6ê°œì›” ë™ì•ˆ ì™„ë§Œí•œ ìƒìŠ¹ì„ ë³´ì˜€ìŠµë‹ˆë‹¤."
    elif v > -0.05:
        return "ìµœê·¼ 6ê°œì›” ë™ì•ˆ í° ë°©í–¥ì„± ì—†ì´ ë³´í•©ê¶Œì— ë¨¸ë¬¼ë €ìŠµë‹ˆë‹¤."
    elif v > -0.20:
        return "ìµœê·¼ 6ê°œì›” ë™ì•ˆ ë‹¤ì†Œ ë¶€ì§„í•œ íë¦„ì„ ë³´ì˜€ìŠµë‹ˆë‹¤."
    else:
        return "ìµœê·¼ 6ê°œì›” ë™ì•ˆ ìƒë‹¹íˆ ë¶€ì§„í•œ íë¦„ì„ ë³´ì˜€ìŠµë‹ˆë‹¤."


def _join_code_list(codes: List[str], max_len: int = 5) -> str:
    """
    ì¢…ëª© ì½”ë“œ ë¦¬ìŠ¤íŠ¸ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ë¬¸ìì—´ë¡œ í•©ì³ì¤Œ.
    """
    if not codes:
        return ""
    if len(codes) == 1:
        return codes[0]
    if len(codes) <= max_len:
        return ", ".join(codes[:-1]) + " ê·¸ë¦¬ê³  " + codes[-1]
    else:
        head = ", ".join(codes[:max_len])
        return f"{head} ë“±"


def _risk_profile_brief(name: str) -> str:
    """
    íˆ¬ì ì„±í–¥ ì´ë¦„ì„ í•œ ì¤„ë¡œ ì§§ê²Œ ì„¤ëª….
    """
    level = _RISK_LEVEL.get(name, 3)
    if level <= 2:
        return "ì „ë°˜ì ìœ¼ë¡œ **ì›ê¸ˆ ì†ì‹¤ì„ í¬ê²Œ ì›ì¹˜ ì•ŠëŠ”, ë¹„êµì  ì•ˆì • ì„±í–¥**ì— ê°€ê¹ìŠµë‹ˆë‹¤."
    elif level == 3:
        return "ì „ë°˜ì ìœ¼ë¡œ **ìˆ˜ìµê³¼ ìœ„í—˜ì„ ê· í˜• ìˆê²Œ ë°”ë¼ë³´ëŠ” ì„±í–¥**ì…ë‹ˆë‹¤."
    else:
        return "ì „ë°˜ì ìœ¼ë¡œ **ìˆ˜ìµì„ ìœ„í•´ ë³€ë™ì„±ì„ ê°ìˆ˜í•  ìˆ˜ ìˆëŠ” ê³µê²©ì ì¸ ì„±í–¥**ì…ë‹ˆë‹¤."


def generate_portfolio_report(
        analysis: AnalysisResult,
        risk_profile_name: str,
        risk_profiles: Dict[str, str] = None
) -> str:
    """
    AnalysisResult + íˆ¬ì ì„±í–¥ ì´ë¦„ì„ ë°›ì•„
    'ìŠ¤í† ë¦¬í…”ë§' í˜•ì‹ì˜ ìì—°ì–´ ë¦¬í¬íŠ¸ ë¬¸ìì—´ì„ ìƒì„±í•œë‹¤.
    (LEVEL 2: ë£° ê¸°ë°˜ + ë¬¸ì¥ ìƒì„± í˜¼í•© ë°©ì‹)
    """
    if risk_profiles is None:
        risk_profiles = RISK_PROFILES

    exposures: pd.Series = analysis.exposures
    norm_exp: pd.Series = analysis.norm_exposures
    target: pd.Series = analysis.target_exposures
    factor_momentum: pd.Series = analysis.factor_momentum

    factors = list(norm_exp.index)  # ["Factor 1", "Factor 2", ...]
    n_factors = len(factors)
    diff = norm_exp - target

    over = analysis.over_factors or []
    under = analysis.under_factors or []

    # ì§€ë°°ì ì¸ ìš”ì¸(ë¹„ì¤‘ ê°€ì¥ í° ìš”ì¸)
    dominant_factor = norm_exp.idxmax()
    dom_idx = factors.index(dominant_factor) + 1
    dom_diff = diff[dominant_factor]
    dom_role = _factor_short_name(dom_idx)

    # ë¦¬í¬íŠ¸ ë¼ì¸ë“¤
    lines: List[str] = []

    # -----------------------------
    # 1. ì œëª© & íˆ¬ì ì„±í–¥ ì†Œê°œ
    # -----------------------------
    lines.append("ğŸŒ± Fin GPTê°€ ì •ë¦¬í•œ ë‚˜ì˜ í¬íŠ¸í´ë¦¬ì˜¤ ìš”ì¸ ë¦¬í¬íŠ¸\n")
    lines.append("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n")

    lines.append("ã€1ã€‘ ë‚˜ì˜ íˆ¬ì ì„±í–¥ í•œ ë²ˆ ë” ì •ë¦¬í•˜ê¸°\n")
    lines.append(f"- íˆ¬ì ì„±í–¥: **{risk_profile_name}**")
    profile_desc = risk_profiles.get(risk_profile_name, "")
    if profile_desc:
        lines.append(f"- ì„±í–¥ ì„¤ëª…: {profile_desc}")
    lines.append(f"- í•œ ì¤„ ìš”ì•½: {_risk_profile_brief(risk_profile_name)}\n")

    # -----------------------------
    # 2. í¬íŠ¸í´ë¦¬ì˜¤ ì²«ì¸ìƒ (ë¸Œë¦¿ì§€ ë¬¸ì¥)
    # -----------------------------
    lines.append("ã€2ã€‘ ì§€ê¸ˆ í¬íŠ¸í´ë¦¬ì˜¤ì˜ ì²« ì¸ìƒ ìš”ì•½\n")

    if not over and not under and abs(dom_diff) < 0.05:
        lines.append(
            "ì „ì²´ì ìœ¼ë¡œ íˆ¬ì ì„±í–¥ê³¼ í¬ê²Œ ì–´ê¸‹ë‚˜ì§€ ì•ŠëŠ”, ë¹„êµì  ê· í˜• ì¡íŒ êµ¬ì¡°ë¡œ ë³´ì…ë‹ˆë‹¤.\n"
            f"ë‹¤ë§Œ ê·¸ì¤‘ì—ì„œë„ **{dominant_factor}({dom_role})** ìš”ì¸ì˜ ë¹„ì¤‘ì´ ê°€ì¥ í¬ê¸° ë•Œë¬¸ì—, "
            "ì‹œì¥ í™˜ê²½ì´ ì´ ìš”ì¸ì— ìœ ë¦¬í•œì§€ ì—¬ë¶€ì— ë”°ë¼ ê³„ì¢Œ ë“±ë½í­ì´ í•¨ê»˜ ì›€ì§ì¼ ê°€ëŠ¥ì„±ì´ í½ë‹ˆë‹¤.\n"
        )
    else:
        if dom_diff > 0:
            lines.append(
                f"ë‹¹ì‹ ì€ **{risk_profile_name}** ì„±í–¥ì´ì§€ë§Œ, ì‹¤ì œ í¬íŠ¸í´ë¦¬ì˜¤ëŠ” "
                f"**{dominant_factor}({dom_role})** ìª½ì— ë¹„ì¤‘ì´ ê°€ì¥ ë§ì´ ì‹¤ë ¤ ìˆìŠµë‹ˆë‹¤.\n"
            )
        else:
            lines.append(
                f"ë‹¹ì‹ ì€ **{risk_profile_name}** ì„±í–¥ì´ì§€ë§Œ, í˜„ì¬ í¬íŠ¸í´ë¦¬ì˜¤ì—ì„œ "
                f"**{dominant_factor}({dom_role})** ìš”ì¸ì˜ ë¹„ì¤‘ì€ ëª©í‘œ ëŒ€ë¹„ ë‹¤ì†Œ ë‚®ì€ í¸ì…ë‹ˆë‹¤.\n"
            )

        if over:
            over_names = ", ".join([f"Factor {i}" for i in over])
            lines.append(f"- íŠ¹íˆ **{over_names}** ìª½ìœ¼ë¡œ ë…¸ì¶œì´ ë‹¤ì†Œ ëª°ë ¤ ìˆëŠ” ëª¨ìŠµì…ë‹ˆë‹¤.")
        if under:
            under_names = ", ".join([f"Factor {i}" for i in under])
            lines.append(f"- ë°˜ëŒ€ë¡œ **{under_names}** ìª½ì€ ì„±í–¥ ëŒ€ë¹„ ìƒëŒ€ì ìœ¼ë¡œ ë…¸ì¶œì´ ë¶€ì¡±í•œ í¸ì…ë‹ˆë‹¤.")

        lines.append("")  # ë¹ˆ ì¤„

    # ê° ìš”ì¸ì˜ ì˜ë¯¸ ê°„ë‹¨ ì •ë¦¬
    lines.append("ê° ìš”ì¸ì´ ëŒ€ëµ ì–´ë–¤ ì„±ê²©ì„ ê°–ëŠ”ì§€, ì•„ì£¼ ë‹¨ìˆœí™”í•´ì„œ ì •ë¦¬í•˜ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:\n")
    for i, f in enumerate(factors, start=1):
        lines.append(f"- {_factor_role_comment(i, f, n_factors)}")
    lines.append("")

    # -----------------------------
    # 3. ëª©í‘œ ë¹„ì¤‘ vs ì‹¤ì œ ë¹„ì¤‘ ë¹„êµ
    # -----------------------------
    lines.append("ã€3ã€‘ íˆ¬ì ì„±í–¥ì— ë¹„ì¶˜ ìš”ì¸ë³„ ë¹„ì¤‘ ì ê²€\n")
    lines.append("ë‹¹ì‹ ì˜ íˆ¬ì ì„±í–¥ì„ ê¸°ì¤€ìœ¼ë¡œ ì„¤ì •í•œ 'ëª©í‘œ ìš”ì¸ ë¹„ì¤‘'ê³¼ ì‹¤ì œ ë¹„ì¤‘ì„ ë¹„êµí•˜ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.\n")

    for i, f in enumerate(factors, start=1):
        a = norm_exp[f]
        t = target[f]
        comment = _diff_comment(a, t)
        lines.append(
            f"- {f}: ì‹¤ì œ {a*100:.1f}%, ëª©í‘œ {t*100:.1f}% â†’ {comment}"
        )

    lines.append("")  # ë¹ˆ ì¤„

    if not over and not under:
        lines.append(
            "ğŸ‘‰ í° ì ë¦¼ ì—†ì´, ì „ë°˜ì ìœ¼ë¡œ íˆ¬ì ì„±í–¥ì— ë¹„êµì  ì˜ ë§ëŠ” ë°°ë¶„ ìƒíƒœì…ë‹ˆë‹¤.\n"
        )
    else:
        pieces = []
        if over:
            pieces.append("ì¼ë¶€ ìš”ì¸ì—ëŠ” ë¹„ì¤‘ì´ ë‹¤ì†Œ ë§ì´ ëª°ë ¤ ìˆê³ ")
        if under:
            pieces.append("ì–´ë–¤ ìš”ì¸ë“¤ì€ ì„±í–¥ì— ë¹„í•´ ë…¸ì¶œì´ ë¶€ì¡±í•œ í¸ì…ë‹ˆë‹¤")
        lines.append(
            "ğŸ‘‰ ìš”ì•½í•˜ë©´, " + " Â· ".join(pieces) + ". "
                                              "ì¥ê¸°ì ì¸ ê´€ì ì—ì„œ ë¦¬ë°¸ëŸ°ì‹±ì„ í•œ ë²ˆ ê³ ë¯¼í•´ ë³¼ ë§Œí•œ êµ¬ì¡°ì…ë‹ˆë‹¤.\n"
        )

    # -----------------------------
    # 4. ì ë¦¼ê³¼ ë¦¬ë°¸ëŸ°ì‹± ì•„ì´ë””ì–´
    # -----------------------------
    lines.append("ã€4ã€‘ ì ë¦¼ì„ ì™„í™”í•˜ê±°ë‚˜ ë³´ì™„í•  ë•Œ ì°¸ê³ í•  ìˆ˜ ìˆëŠ” ì•„ì´ë””ì–´\n")

    trim = analysis.trim_candidates or {}
    add = analysis.add_candidates or {}

    if trim:
        lines.append("â‘  **ê³¼íˆ¬ìëœ(ë¹„ì¤‘ì´ ë§ì€) ìš”ì¸ ìª½ì—ì„œ ë¹„ì¤‘ì„ ì¤„ì¼ ë•Œ** ì°¸ê³ í•  ìˆ˜ ìˆëŠ” ì¢…ëª©ë“¤ì…ë‹ˆë‹¤.\n")
        for f_idx, stocks in trim.items():
            if not stocks:
                continue
            fname = f"Factor {f_idx}"
            joined = _join_code_list(stocks)
            lines.append(f"- {fname} ê´€ë ¨ ë¹„ì¤‘ ì¶•ì†Œ í›„ë³´: {joined}")
        lines.append(
            "\nì´ ì¢…ëª©ë“¤ì€ í•´ë‹¹ ìš”ì¸ì˜ ì›€ì§ì„ì— ìƒëŒ€ì ìœ¼ë¡œ ë¯¼ê°í•œ í¸ì´ë¼, "
            "ë¹„ì¤‘ì„ ì¡°ê¸ˆë§Œ ì¤„ì—¬ë„ ê·¸ ìš”ì¸ì— ëŒ€í•œ ì „ì²´ ë…¸ì¶œì´ ì™„í™”ë˜ëŠ” íš¨ê³¼ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n"
        )
    else:
        lines.append(
            "í˜„ì¬ ëšœë ·í•˜ê²Œ 'ë„ˆë¬´ ë§ì´ ë‹´ì•˜ë‹¤'ê³  íŒë‹¨ë˜ëŠ” ìš”ì¸ì€ í¬ì§€ ì•Šì•„ì„œ, "
            "ì¦‰ì‹œ ë¹„ì¤‘ ì¶•ì†Œê°€ ê¼­ í•„ìš”í•´ ë³´ì´ì§„ ì•ŠìŠµë‹ˆë‹¤.\n"
        )

    if add:
        lines.append("â‘¡ **ë¶€ì¡±í•œ ìš”ì¸ì„ ë³´ì™„í•˜ê¸° ìœ„í•´ ì¶”ê°€ë¡œ ë‹´ì„ ë•Œ** ì°¸ê³ í•  ìˆ˜ ìˆëŠ” ì¢…ëª©ë“¤ì…ë‹ˆë‹¤.\n")
        for f_idx, stocks in add.items():
            if not stocks:
                continue
            fname = f"Factor {f_idx}"
            joined = _join_code_list(stocks)
            lines.append(f"- {fname} ë…¸ì¶œì„ ëŠ˜ë¦´ ë•Œ ì°¸ê³ í•  ì¢…ëª©: {joined}")
        lines.append(
            "\nìœ„ ì¢…ëª©ë“¤ì€ í•´ë‹¹ ìš”ì¸ì— ëŒ€í•œ ë…¸ì¶œì´ ìƒëŒ€ì ìœ¼ë¡œ ë†’ì€ í¸ì´ë¼, "
            "ì¥ê¸°ì ìœ¼ë¡œ ì¡°ê¸ˆì”© í¸ì…í•˜ë©´ íˆ¬ì ì„±í–¥ì— ë§ëŠ” ëª©í‘œ ë¹„ì¤‘ì— ê°€ê¹Œì›Œì§€ëŠ” ë° ë„ì›€ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n"
        )
    else:
        lines.append(
            "ë¶€ì¡±í•œ ìš”ì¸ì„ ë³´ì™„í•˜ê¸° ìœ„í•´ ë‹¹ì¥ íŠ¹ì • ì¢…ëª©ì„ ëŠ˜ë ¤ì•¼ í•  ì •ë„ì˜ ì ë¦¼ì€ í¬ì§€ ì•Šì€ í¸ì…ë‹ˆë‹¤.\n"
        )

    # -----------------------------
    # 5. ìµœê·¼ 6ê°œì›” ìš”ì¸ ì„±ê³¼
    # -----------------------------
    lines.append("ã€5ã€‘ ìµœê·¼ 6ê°œì›” ë™ì•ˆ ê° ìš”ì¸ì˜ ì„±ê³¼\n")
    lines.append("ìµœê·¼ 6ê°œì›” ëˆ„ì  ìˆ˜ìµë¥  ê¸°ì¤€ìœ¼ë¡œ, ì–´ë–¤ ìš”ì¸ì´ í˜ì„ ì“°ê³  ìˆì—ˆëŠ”ì§€ ì •ë¦¬í•˜ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.\n")

    sorted_mom = factor_momentum.sort_values(ascending=False)

    best_factor = None
    worst_factor = None
    if len(sorted_mom) > 0:
        best_factor = sorted_mom.index[0]
        worst_factor = sorted_mom.index[-1]

    for f, v in sorted_mom.items():
        lines.append(f"- {f}: {v*100:.2f}% â†’ {_momentum_comment(v)}")

    lines.append("")

    if best_factor and worst_factor:
        lines.append(
            f"ğŸ‘‰ ìš”ì•½í•˜ë©´, ìµœê·¼ 6ê°œì›” ë™ì•ˆì—ëŠ” **{best_factor}** ìš”ì¸ì´ ìƒëŒ€ì ìœ¼ë¡œ ê°€ì¥ ì¢‹ì€ ì„±ê³¼ë¥¼, "
            f"**{worst_factor}** ìš”ì¸ì€ ê°€ì¥ ì•„ì‰¬ìš´ ì„±ê³¼ë¥¼ ë³´ì—¬ì¤€ í¸ì…ë‹ˆë‹¤.\n"
        )

    # -----------------------------
    # 6. í•œ ì¤„ ì •ë¦¬ & ë§ˆë¬´ë¦¬
    # -----------------------------
    lines.append("ã€6ã€‘ í•œ ì¤„ë¡œ ì •ë¦¬í•˜ë©´\n")

    if not over and not under:
        main_comment = (
            "íˆ¬ì ì„±í–¥ì— ë¹„í•´ í¬ê²Œ íŠ€ëŠ” ì ë¦¼ì€ ì—†ê³ , "
            "ë‹¤ë§Œ íŠ¹ì • ìš”ì¸ì˜ í™˜ê²½ì— ë”°ë¼ ê³„ì¢Œ ë“±ë½í­ì´ ì¢Œìš°ë  ìˆ˜ ìˆëŠ” 'ë¬´ë‚œí•œ ë¶„ì‚° í¬íŠ¸í´ë¦¬ì˜¤'ì— ê°€ê¹ìŠµë‹ˆë‹¤."
        )
    else:
        parts = []
        if over:
            over_names = ", ".join([f"Factor {i}" for i in over])
            parts.append(f"{over_names} ìª½ìœ¼ë¡œ ë¹„ì¤‘ì´ ë‹¤ì†Œ ëª°ë ¤ ìˆê³ ")
        if under:
            under_names = ", ".join([f"Factor {i}" for i in under])
            parts.append(f"{under_names} ìª½ì€ ì„±í–¥ ëŒ€ë¹„ ìƒëŒ€ì ìœ¼ë¡œ ë…¸ì¶œì´ ì ì€ í¸ì…ë‹ˆë‹¤")
        main_comment = " / ".join(parts) + "."

    lines.append(f"> {main_comment}\n")

    lines.append(
        "ì´ ë¦¬í¬íŠ¸ëŠ” ê³¼ê±° ë°ì´í„°ì™€ í†µê³„ì  ê¸°ë²•(PCA)ìœ¼ë¡œ **í¬íŠ¸í´ë¦¬ì˜¤ì˜ êµ¬ì¡°ì™€ ì„±ê²©ì„ ì„¤ëª…í•´ ì£¼ëŠ” ë„êµ¬**ì¼ ë¿, "
        "íŠ¹ì • ì¢…ëª©ì˜ ë§¤ìˆ˜Â·ë§¤ë„ë¥¼ ì§ì ‘ì ìœ¼ë¡œ ê¶Œìœ í•˜ëŠ” ê²ƒì€ ì•„ë‹™ë‹ˆë‹¤. "
        "ë‹¤ë§Œ, ì•ìœ¼ë¡œ ë¦¬ë°¸ëŸ°ì‹±ì„ ê³ ë¯¼í•  ë•Œ 'ì–´ë””ì— ì ë ¤ ìˆê³ , ë¬´ì—‡ì„ ë³´ì™„í• ì§€'ë¥¼ "
        "í•œëˆˆì— ì •ë¦¬í•´ ì£¼ëŠ” ì°¸ê³ ìš© ë‚˜ì¹¨ë°˜ìœ¼ë¡œ í™œìš©í•´ ì£¼ì„¸ìš”.\n"
    )

    return "\n".join(lines)
